<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Media Editor Suite</title>
    <style>
        :root {
            --primary: #2b579a;
            --secondary: #e5e5e5;
            --accent: #f25022;
            --dark: #1e1e1e;
            --light: #ffffff;
            --ribbon-height: 120px;
            --sidebar-width: 220px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Frutiger, "Frutiger Linotype", "Dejavu Sans", "Helvetica Neue", Arial, sans-serif;
        }

        body {
            display: grid;
            grid-template-rows: auto var(--ribbon-height) 1fr auto;
            height: 100vh;
            background: #f5f5f5;
            color: #333;
            overflow: hidden;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            height: 50px;
            background: var(--primary);
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .app-controls {
            display: flex;
            gap: 8px;
        }

        .app-controls button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
        }

        /* Ribbon */
        .ribbon {
            display: flex;
            flex-direction: column;
            background: white;
            border-bottom: 1px solid #dcdcdc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .ribbon-tabs {
            display: flex;
            height: 40px;
            border-bottom: 1px solid #dcdcdc;
        }

        .ribbon-tab {
            padding: 0 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            position: relative;
        }

        .ribbon-tab.active {
            background: var(--secondary);
            font-weight: 500;
        }

        .ribbon-tab.active:after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }

        .ribbon-content {
            display: none;
            padding: 10px;
            height: calc(var(--ribbon-height) - 40px);
            overflow-x: auto;
        }

        .ribbon-content.active {
            display: flex;
            flex-wrap: nowrap;
            gap: 15px;
        }

        .ribbon-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
            border-right: 1px solid #e0e0e0;
            padding-right: 15px;
        }

        .ribbon-group:last-child {
            border-right: none;
        }

        .ribbon-group-title {
            font-size: 11px;
            margin-bottom: 8px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            padding-left: 5px;
        }

        .ribbon-buttons {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .ribbon-button {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            background: none;
            border: none;
            text-align: left;
        }

        .ribbon-button:hover {
            background: #ebf3fc;
        }

        .ribbon-button.active {
            background: #d5e3f5;
        }

        .ribbon-button .icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            height: 100%;
            overflow: hidden;
        }

        .sidebar {
            background: #f0f0f0;
            border-right: 1px solid #dcdcdc;
            overflow-y: auto;
            padding: 10px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section h3 {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            padding-left: 5px;
            font-weight: 600;
        }

        .sidebar-item {
            padding: 6px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sidebar-item:hover {
            background: #e5e5e5;
        }

        .sidebar-item .icon {
            font-size: 14px;
            width: 20px;
        }

        .workspace {
            display: grid;
            grid-template-rows: 1fr auto;
            overflow: hidden;
            background: white;
            position: relative;
        }

        .editor-area {
            overflow: auto;
            padding: 20px;
            position: relative;
        }

        .media-preview {
            border-top: 1px solid #dcdcdc;
            background: #f5f5f5;
            padding: 10px;
            max-height: 200px;
            overflow: auto;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            padding: 5px 10px;
            background: var(--primary);
            color: white;
            font-size: 11px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Media Elements */
        canvas, video, audio {
            max-width: 100%;
            background: #eee;
        }

        .media-container {
            margin: 10px 0;
            position: relative;
        }

        .media-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        /* Loading */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #dcdcdc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            min-width: 150px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
        }

        .context-menu-item:hover {
            background: #ebf3fc;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="app-title">
            <span class="icon">‚úª</span>
            <span>Ultimate Media Editor</span>
        </div>
        <div class="app-controls">
            <button id="file-btn">File</button>
            <button id="save-btn">Salva</button>
            <button id="export-btn">Esporta</button>
        </div>
    </div>
    
    <!-- Ribbon -->
    <div class="ribbon">
        <div class="ribbon-tabs">
            <div class="ribbon-tab active" data-tab="home">Home</div>
            <div class="ribbon-tab" data-tab="media">Media</div>
            <div class="ribbon-tab" data-tab="audio">Audio</div>
            <div class="ribbon-tab" data-tab="video">Video</div>
            <div class="ribbon-tab" data-tab="cad">CAD</div>
            <div class="ribbon-tab" data-tab="view">Visualizza</div>
        </div>
        
        <!-- Home Tab -->
        <div class="ribbon-content active" data-content="home">
            <div class="ribbon-group">
                <div class="ribbon-group-title">File</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="new-file">
                        <span class="icon">üìÑ</span>
                        <span>Nuovo</span>
                    </button>
                    <button class="ribbon-button" id="open-file">
                        <span class="icon">üìÇ</span>
                        <span>Apri</span>
                    </button>
                    <button class="ribbon-button" id="save-file">
                        <span class="icon">üíæ</span>
                        <span>Salva</span>
                    </button>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Modifica</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="undo-btn">
                        <span class="icon">‚Ü©Ô∏è</span>
                        <span>Annulla</span>
                    </button>
                    <button class="ribbon-button" id="redo-btn">
                        <span class="icon">‚Ü™Ô∏è</span>
                        <span>Ripeti</span>
                    </button>
                    <button class="ribbon-button" id="clear-btn">
                        <span class="icon">üóëÔ∏è</span>
                        <span>Elimina</span>
                    </button>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Visualizza</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="zoom-in">
                        <span class="icon">üîç</span>
                        <span>Ingrandisci</span>
                    </button>
                    <button class="ribbon-button" id="zoom-out">
                        <span class="icon">üîç</span>
                        <span>Riduci</span>
                    </button>
                    <button class="ribbon-button" id="fullscreen">
                        <span class="icon">‚õ∂</span>
                        <span>Schermo intero</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Media Tab -->
        <div class="ribbon-content" data-content="media">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Immagini</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="insert-image">
                        <span class="icon">üñºÔ∏è</span>
                        <span>Inserisci</span>
                    </button>
                    <button class="ribbon-button" id="crop-image">
                        <span class="icon">‚úÇÔ∏è</span>
                        <span>Ritaglia</span>
                    </button>
                    <button class="ribbon-button" id="adjust-image">
                        <span class="icon">üé®</span>
                        <span>Regola</span>
                    </button>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Filtri</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="filter-bw">
                        <span class="icon">‚ö´</span>
                        <span>Bianco/Nero</span>
                    </button>
                    <button class="ribbon-button" id="filter-sepia">
                        <span class="icon">üü§</span>
                        <span>Seppia</span>
                    </button>
                    <button class="ribbon-button" id="filter-sharpen">
                        <span class="icon">üîç</span>
                        <span>Nitidezza</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Audio Tab -->
        <div class="ribbon-content" data-content="audio">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Audio</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="import-audio">
                        <span class="icon">üéµ</span>
                        <span>Importa</span>
                    </button>
                    <button class="ribbon-button" id="record-audio">
                        <span class="icon">üéôÔ∏è</span>
                        <span>Registra</span>
                    </button>
                    <button class="ribbon-button" id="export-audio">
                        <span class="icon">üì§</span>
                        <span>Esporta</span>
                    </button>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Effetti</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="audio-eq">
                        <span class="icon">üìä</span>
                        <span>Equalizzatore</span>
                    </button>
                    <button class="ribbon-button" id="audio-reverb">
                        <span class="icon">üèõÔ∏è</span>
                        <span>Riverbero</span>
                    </button>
                    <button class="ribbon-button" id="audio-noise">
                        <span class="icon">üîá</span>
                        <span>Riduci rumore</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Video Tab -->
        <div class="ribbon-content" data-content="video">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Video</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="import-video">
                        <span class="icon">üé¨</span>
                        <span>Importa</span>
                    </button>
                    <button class="ribbon-button" id="record-video">
                        <span class="icon">üìπ</span>
                        <span>Registra</span>
                    </button>
                    <button class="ribbon-button" id="export-video">
                        <span class="icon">üì§</span>
                        <span>Esporta</span>
                    </button>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Editing</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="cut-video">
                        <span class="icon">‚úÇÔ∏è</span>
                        <span>Taglia</span>
                    </button>
                    <button class="ribbon-button" id="merge-video">
                        <span class="icon">üîó</span>
                        <span>Unisci</span>
                    </button>
                    <button class="ribbon-button" id="effects-video">
                        <span class="icon">‚ú®</span>
                        <span>Effetti</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- CAD Tab -->
        <div class="ribbon-content" data-content="cad">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Modelli</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="import-cad">
                        <span class="icon">üìÅ</span>
                        <span>Importa</span>
                    </button>
                    <button class="ribbon-button" id="new-cad">
                        <span class="icon">üÜï</span>
                        <span>Nuovo</span>
                    </button>
                    <button class="ribbon-button" id="export-cad">
                        <span class="icon">üì§</span>
                        <span>Esporta</span>
                    </button>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Strumenti</div>
                <div class="ribbon-buttons">
                    <button class="ribbon-button" id="measure-cad">
                        <span class="icon">üìè</span>
                        <span>Misura</span>
                    </button>
                    <button class="ribbon-button" id="rotate-cad">
                        <span class="icon">üîÑ</span>
                        <span>Ruota</span>
                    </button>
                    <button class="ribbon-button" id="section-cad">
                        <span class="icon">‚úÇÔ∏è</span>
                        <span>Sezione</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <h3>File Recenti</h3>
                <div class="sidebar-item">
                    <span class="icon">üìÑ</span>
                    <span>Progetto 1</span>
                </div>
                <div class="sidebar-item">
                    <span class="icon">üé¨</span>
                    <span>Video Promo</span>
                </div>
                <div class="sidebar-item">
                    <span class="icon">üìê</span>
                    <span>Modello 3D</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Strumenti Rapidi</h3>
                <div class="sidebar-item" id="quick-image">
                    <span class="icon">üñºÔ∏è</span>
                    <span>Nuova Immagine</span>
                </div>
                <div class="sidebar-item" id="quick-audio">
                    <span class="icon">üéµ</span>
                    <span>Nuovo Audio</span>
                </div>
                <div class="sidebar-item" id="quick-video">
                    <span class="icon">üé¨</span>
                    <span>Nuovo Video</span>
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3>Propriet√†</h3>
                <div id="properties-container">
                    <p style="padding: 8px; color: #666;">Nessun elemento selezionato</p>
                </div>
            </div>
        </div>
        
        <!-- Workspace -->
        <div class="workspace">
            <div class="editor-area" id="editor-area">
                <div class="loading-overlay" id="loading-overlay" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p id="loading-text" style="margin-top: 10px;">Caricamento in corso...</p>
                </div>
                
                <div id="content-container">
                    <div style="text-align: center; padding: 50px;">
                        <h2 style="color: #666; margin-bottom: 20px;">Ultimate Media Editor</h2>
                        <p>Seleziona uno strumento dalla barra multifunzione o trascina un file qui</p>
                    </div>
                </div>
            </div>
            
            <div class="media-preview" id="media-preview">
                <h3 style="font-size: 13px; margin-bottom: 8px;">Anteprima Media</h3>
                <div id="preview-container"></div>
                <div class="media-controls" id="media-controls" style="display: none;">
                    <button id="play-btn">‚ñ∂Ô∏è Riproduci</button>
                    <button id="pause-btn">‚è∏Ô∏è Pausa</button>
                    <button id="stop-btn">‚èπÔ∏è Stop</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <span id="file-info">Nessun file aperto</span>
            <span id="selection-info">Nessuna selezione</span>
        </div>
        <div class="status-item">
            <span id="zoom-level">100%</span>
            <span id="resolution-info">-</span>
        </div>
    </div>
    
    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="ctx-copy">Copia</div>
        <div class="context-menu-item" id="ctx-cut">Taglia</div>
        <div class="context-menu-item" id="ctx-paste">Incolla</div>
        <div class="context-menu-item" id="ctx-delete">Elimina</div>
        <div class="context-menu-item" id="ctx-properties">Propriet√†</div>
    </div>

    <script>
        // Stato globale dell'applicazione
        const appState = {
            currentTab: 'home',
            activeFile: null,
            zoomLevel: 100,
            history: [],
            historyIndex: -1,
            audioContext: null,
            mediaRecorder: null,
            activeTool: null,
            selectedElement: null
        };

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', () => {
            setupUI();
            setupEventListeners();
            initializeModules();
        });

        function setupUI() {
            // Attiva il tab iniziale
            switchTab('home');
            
            // Aggiorna lo stato iniziale
            updateStatusBar();
        }

        function setupEventListeners() {
            // Gestione tab
            document.querySelectorAll('.ribbon-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });
            
            // Pulsanti file
            document.getElementById('new-file').addEventListener('click', newFile);
            document.getElementById('open-file').addEventListener('click', openFile);
            document.getElementById('save-file').addEventListener('click', saveFile);
            
            // Pulsanti media
            document.getElementById('insert-image').addEventListener('click', insertImage);
            document.getElementById('crop-image').addEventListener('click', startCropTool);
            document.getElementById('adjust-image').addEventListener('click', showAdjustPanel);
            
            // Pulsanti audio
            document.getElementById('import-audio').addEventListener('click', importAudio);
            document.getElementById('record-audio').addEventListener('click', toggleAudioRecording);
            document.getElementById('audio-eq').addEventListener('click', showEqualizer);
            
            // Pulsanti video
            document.getElementById('import-video').addEventListener('click', importVideo);
            document.getElementById('cut-video').addEventListener('click', startCutTool);
            
            // Pulsanti CAD
            document.getElementById('import-cad').addEventListener('click', importCAD);
            document.getElementById('measure-cad').addEventListener('click', startMeasureTool);
            
            // Zoom
            document.getElementById('zoom-in').addEventListener('click', () => adjustZoom(10));
            document.getElementById('zoom-out').addEventListener('click', () => adjustZoom(-10));
            
            // Drag and drop
            const editorArea = document.getElementById('editor-area');
            editorArea.addEventListener('dragover', handleDragOver);
            editorArea.addEventListener('drop', handleDrop);
            
            // Context menu
            document.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('click', () => {
                document.getElementById('context-menu').style.display = 'none';
            });
        }

        function initializeModules() {
            // Inizializza l'audio context quando l'utente interagisce
            document.body.addEventListener('click', () => {
                if (!appState.audioContext) {
                    appState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
            }, { once: true });
        }

        function switchTab(tabName) {
            appState.currentTab = tabName;
            
            // Aggiorna l'UI
            document.querySelectorAll('.ribbon-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            document.querySelectorAll('.ribbon-content').forEach(content => {
                content.classList.toggle('active', content.dataset.content === tabName);
            });
        }

        function newFile() {
            if (confirm('Vuoi creare un nuovo file? Tutte le modifiche non salvate andranno perse.')) {
                document.getElementById('content-container').innerHTML = '';
                appState.activeFile = null;
                appState.history = [];
                appState.historyIndex = -1;
                updateStatusBar();
            }
        }

        function openFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,audio/*,video/*,.stl,.step,.iges';
            input.onchange = e => {
                if (e.target.files.length) {
                    loadFile(e.target.files[0]);
                }
            };
            input.click();
        }

        function loadFile(file) {
            showLoading(`Caricamento ${file.name}...`);
            appState.activeFile = file;
            
            // Determina il tipo di file
            const fileType = detectFileType(file.name);
            
            // Simula il caricamento
            setTimeout(() => {
                hideLoading();
                
                switch(fileType) {
                    case 'image':
                        displayImage(file);
                        break;
                    case 'audio':
                        displayAudio(file);
                        break;
                    case 'video':
                        displayVideo(file);
                        break;
                    case 'cad':
                        displayCAD(file);
                        break;
                    default:
                        alert('Formato file non supportato');
                }
                
                updateStatusBar();
                addToHistory();
            }, 500);
        }

        function detectFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const audioExts = ['mp3', 'wav', 'ogg', 'aac'];
            const videoExts = ['mp4', 'webm', 'mov', 'avi'];
            const cadExts = ['stl', 'step', 'iges'];
            
            if (imageExts.includes(ext)) return 'image';
            if (audioExts.includes(ext)) return 'audio';
            if (videoExts.includes(ext)) return 'video';
            if (cadExts.includes(ext)) return 'cad';
            return 'unknown';
        }

        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '100%';
                
                const container = document.getElementById('content-container');
                container.innerHTML = '';
                container.appendChild(img);
                
                // Setup preview
                setupImagePreview(img);
                
                // Seleziona l'elemento
                selectElement(img);
            };
            reader.readAsDataURL(file);
        }

        function displayAudio(file) {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = URL.createObjectURL(file);
            
            const container = document.getElementById('content-container');
            container.innerHTML = '';
            container.appendChild(audio);
            
            // Setup preview e controlli
            setupAudioPreview(audio);
            
            // Seleziona l'elemento
            selectElement(audio);
        }

        function displayVideo(file) {
            const video = document.createElement('video');
            video.controls = true;
            video.src = URL.createObjectURL(file);
            
            const container = document.getElementById('content-container');
            container.innerHTML = '';
            container.appendChild(video);
            
            // Setup preview e controlli
            setupVideoPreview(video);
            
            // Seleziona l'elemento
            selectElement(video);
        }

        function displayCAD(file) {
            // Simulazione visualizzazione CAD
            const container = document.getElementById('content-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3>${file.name}</h3>
                    <canvas id="cad-canvas" width="600" height="400" style="background: #eee;"></canvas>
                    <p>Modello CAD caricato - Usa gli strumenti CAD per interagire</p>
                </div>
            `;
            
            // Simula rendering 3D
            const canvas = document.getElementById('cad-canvas');
            const ctx = canvas.getContext('2d');
            drawWireframeCube(ctx, canvas.width, canvas.height);
            
            // Setup preview
            setupCADPreview(canvas);
            
            // Seleziona l'elemento
            selectElement(canvas);
        }

        function drawWireframeCube(ctx, width, height) {
            ctx.strokeStyle = '#4361ee';
            ctx.lineWidth = 2;
            
            const centerX = width / 2;
            const centerY = height / 2;
            const size = Math.min(width, height) * 0.3;
            
            // Punti del cubo
            const points = [
                { x: -1, y: -1, z: -1 },
                { x: 1, y: -1, z: -1 },
                { x: 1, y: 1, z: -1 },
                { x: -1, y: 1, z: -1 },
                { x: -1, y: -1, z: 1 },
                { x: 1, y: -1, z: 1 },
                { x: 1, y: 1, z: 1 },
                { x: -1, y: 1, z: 1 }
            ];
            
            // Proietta i punti 3D in 2D
            const projected = points.map(p => {
                return {
                    x: centerX + p.x * size,
                    y: centerY + p.y * size * 0.5 - p.z * size * 0.5
                };
            });
            
            // Collega i punti
            ctx.beginPath();
            
            // Faccia anteriore
            ctx.moveTo(projected[0].x, projected[0].y);
            for (let i = 1; i < 4; i++) {
                ctx.lineTo(projected[i].x, projected[i].y);
            }
            ctx.lineTo(projected[0].x, projected[0].y);
            
            // Faccia posteriore
            ctx.moveTo(projected[4].x, projected[4].y);
            for (let i = 5; i < 8; i++) {
                ctx.lineTo(projected[i].x, projected[i].y);
            }
            ctx.lineTo(projected[4].x, projected[4].y);
            
            // Collegamenti
            for (let i = 0; i < 4; i++) {
                ctx.moveTo(projected[i].x, projected[i].y);
                ctx.lineTo(projected[i+4].x, projected[i+4].y);
            }
            
            ctx.stroke();
        }

        function setupImagePreview(img) {
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '<h4>Anteprima Immagine</h4>';
            
            const previewImg = document.createElement('img');
            previewImg.src = img.src;
            previewImg.style.maxWidth = '100%';
            previewContainer.appendChild(previewImg);
            
            document.getElementById('media-controls').style.display = 'none';
        }

        function setupAudioPreview(audio) {
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = `
                <h4>Waveform Audio</h4>
                <div style="height: 80px; background: linear-gradient(90deg, #4361ee 0%, #4361ee 30%, #3a0ca3 70%, #3a0ca3 100%); border-radius: 4px;"></div>
                <p>${audio.src.substring(audio.src.lastIndexOf('/') + 1)}</p>
            `;
            
            const controls = document.getElementById('media-controls');
            controls.style.display = 'flex';
            controls.querySelector('#play-btn').onclick = () => audio.play();
            controls.querySelector('#pause-btn').onclick = () => audio.pause();
            controls.querySelector('#stop-btn').onclick = () => {
                audio.pause();
                audio.currentTime = 0;
            };
        }

        function setupVideoPreview(video) {
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = `
                <h4>Timeline Video</h4>
                <div style="height: 60px; background: #334155; position: relative;">
                    <div style="position: absolute; top: 0; left: 0; height: 100%; width: 30%; background: #4361ee;"></div>
                </div>
                <p>${video.src.substring(video.src.lastIndexOf('/') + 1)}</p>
            `;
            
            const controls = document.getElementById('media-controls');
            controls.style.display = 'flex';
            controls.querySelector('#play-btn').onclick = () => video.play();
            controls.querySelector('#pause-btn').onclick = () => video.pause();
            controls.querySelector('#stop-btn').onclick = () => {
                video.pause();
                video.currentTime = 0;
            };
        }

        function setupCADPreview(canvas) {
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = `
                <h4>Vista 3D</h4>
                <canvas width="200" height="150" style="background: #eee;"></canvas>
            `;
            
            // Copia il modello ridimensionato
            const previewCtx = previewContainer.querySelector('canvas').getContext('2d');
            drawWireframeCube(previewCtx, 200, 150);
            
            document.getElementById('media-controls').style.display = 'none';
        }

        function selectElement(element) {
            // Rimuovi la selezione precedente
            if (appState.selectedElement) {
                appState.selectedElement.style.outline = '';
                appState.selectedElement.style.boxShadow = '';
            }
            
            // Seleziona il nuovo elemento
            appState.selectedElement = element;
            element.style.outline = '2px solid #4361ee';
            element.style.boxShadow = '0 0 5px rgba(67, 97, 238, 0.5)';
            
            // Aggiorna le propriet√†
            updatePropertiesPanel(element);
        }

        function updatePropertiesPanel(element) {
            const propsContainer = document.getElementById('properties-container');
            
            if (element.tagName === 'IMG') {
                propsContainer.innerHTML = `
                    <h3 style="font-size: 13px; margin-bottom: 10px;">Propriet√† Immagine</h3>
                    <div style="display: grid; grid-template-columns: 80px 1fr; gap: 5px; font-size: 12px;">
                        <div>Larghezza:</div>
                        <div>${element.naturalWidth}px</div>
                        <div>Altezza:</div>
                        <div>${element.naturalHeight}px</div>
                        <div>Formato:</div>
                        <div>${element.src.split('.').pop().toUpperCase()}</div>
                    </div>
                `;
            } else if (element.tagName === 'AUDIO') {
                propsContainer.innerHTML = `
                    <h3 style="font-size: 13px; margin-bottom: 10px;">Propriet√† Audio</h3>
                    <div style="display: grid; grid-template-columns: 80px 1fr; gap: 5px; font-size: 12px;">
                        <div>Durata:</div>
                        <div>${element.duration.toFixed(2)}s</div>
                        <div>Formato:</div>
                        <div>${element.src.split('.').pop().toUpperCase()}</div>
                    </div>
                `;
            } else if (element.tagName === 'VIDEO') {
                propsContainer.innerHTML = `
                    <h3 style="font-size: 13px; margin-bottom: 10px;">Propriet√† Video</h3>
                    <div style="display: grid; grid-template-columns: 80px 1fr; gap: 5px; font-size: 12px;">
                        <div>Risoluzione:</div>
                        <div>${element.videoWidth}x${element.videoHeight}</div>
                        <div>Durata:</div>
                        <div>${element.duration.toFixed(2)}s</div>
                        <div>Formato:</div>
                        <div>${element.src.split('.').pop().toUpperCase()}</div>
                    </div>
                `;
            } else if (element.id === 'cad-canvas') {
                propsContainer.innerHTML = `
                    <h3 style="font-size: 13px; margin-bottom: 10px;">Propriet√† CAD</h3>
                    <div style="display: grid; grid-template-columns: 80px 1fr; gap: 5px; font-size: 12px;">
                        <div>Tipo:</div>
                        <div>Modello 3D</div>
                        <div>Dimensione:</div>
                        <div>${appState.activeFile.size / 1024} KB</div>
                        <div>Formato:</div>
                        <div>${appState.activeFile.name.split('.').pop().toUpperCase()}</div>
                    </div>
                `;
            }
        }

        function showLoading(message) {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('loading-text').textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function updateStatusBar() {
            document.getElementById('file-info').textContent = 
                appState.activeFile ? appState.activeFile.name : 'Nessun file aperto';
            
            if (appState.selectedElement) {
                let type = '';
                if (appState.selectedElement.tagName === 'IMG') type = 'Immagine';
                else if (appState.selectedElement.tagName === 'AUDIO') type = 'Audio';
                else if (appState.selectedElement.tagName === 'VIDEO') type = 'Video';
                else if (appState.selectedElement.id === 'cad-canvas') type = 'Modello CAD';
                
                document.getElementById('selection-info').textContent = type;
            } else {
                document.getElementById('selection-info').textContent = 'Nessuna selezione';
            }
            
            document.getElementById('zoom-level').textContent = `${appState.zoomLevel}%`;
        }

        function adjustZoom(amount) {
            appState.zoomLevel = Math.max(50, Math.min(200, appState.zoomLevel + amount));
            document.getElementById('content-container').style.transform = `scale(${appState.zoomLevel / 100})`;
            updateStatusBar();
        }

        function addToHistory() {
            // Implementazione semplificata dello storico
            const state = {
                content: document.getElementById('content-container').innerHTML,
                file: appState.activeFile
            };
            
            appState.history = appState.history.slice(0, appState.historyIndex + 1);
            appState.history.push(state);
            appState.historyIndex = appState.history.length - 1;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
            document.getElementById('editor-area').style.backgroundColor = 'rgba(67, 97, 238, 0.1)';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('editor-area').style.backgroundColor = '';
            
            if (e.dataTransfer.files.length) {
                loadFile(e.dataTransfer.files[0]);
            }
        }

        function handleContextMenu(e) {
            e.preventDefault();
            
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.top = `${e.pageY}px`;
        }

        // Funzioni specifiche per i tool
        function insertImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                if (e.target.files.length) {
                    displayImage(e.target.files[0]);
                }
            };
            input.click();
        }

        function startCropTool() {
            if (!appState.selectedElement || appState.selectedElement.tagName !== 'IMG') {
                alert('Seleziona un\'immagine prima di usare lo strumento ritaglio');
                return;
            }
            
            alert('Strumento ritaglio attivato - Implementazione completa richiederebbe una libreria come Cropper.js');
        }

        function showAdjustPanel() {
            if (!appState.selectedElement || appState.selectedElement.tagName !== 'IMG') {
                alert('Seleziona un\'immagine prima di regolare');
                return;
            }
            
            alert('Pannello regolazioni - Implementazione completa richiederebbe WebGL per filtri avanzati');
        }

        function importAudio() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*';
            input.onchange = e => {
                if (e.target.files.length) {
                    displayAudio(e.target.files[0]);
                }
            };
            input.click();
        }

        function toggleAudioRecording() {
            if (!appState.mediaRecorder) {
                startAudioRecording();
            } else {
                stopAudioRecording();
            }
        }

        function startAudioRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    appState.mediaRecorder = new MediaRecorder(stream);
                    const audioChunks = [];
                    
                    appState.mediaRecorder.ondataavailable = e => {
                        audioChunks.push(e.data);
                    };
                    
                    appState.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        displayAudio(audioBlob);
                    };
                    
                    appState.mediaRecorder.start();
                    alert('Registrazione audio iniziata - Clicca di nuovo per fermare');
                })
                .catch(err => {
                    console.error('Errore accesso microfono:', err);
                    alert('Impossibile accedere al microfono');
                });
        }

        function stopAudioRecording() {
            if (appState.mediaRecorder) {
                appState.mediaRecorder.stop();
                appState.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                appState.mediaRecorder = null;
            }
        }

        function showEqualizer() {
            if (!appState.selectedElement || appState.selectedElement.tagName !== 'AUDIO') {
                alert('Seleziona un audio prima di usare l\'equalizzatore');
                return;
            }
            
            alert('Equalizzatore - Implementazione completa richiederebbe Web Audio API');
        }

        function importVideo() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'video/*';
            input.onchange = e => {
                if (e.target.files.length) {
                    displayVideo(e.target.files[0]);
                }
            };
            input.click();
        }

        function startCutTool() {
            if (!appState.selectedElement || appState.selectedElement.tagName !== 'VIDEO') {
                alert('Seleziona un video prima di usare lo strumento taglia');
                return;
            }
            
            alert('Strumento taglia video - Implementazione completa richiederebbe FFmpeg.js');
        }

        function importCAD() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.stl,.step,.iges';
            input.onchange = e => {
                if (e.target.files.length) {
                    displayCAD(e.target.files[0]);
                }
            };
            input.click();
        }

        function startMeasureTool() {
            if (!appState.selectedElement || appState.selectedElement.id !== 'cad-canvas') {
                alert('Seleziona un modello CAD prima di usare lo strumento misura');
                return;
            }
            
            alert('Strumento misura - Implementazione completa richiederebbe Three.js con raycasting');
        }

        function saveFile() {
            if (!appState.activeFile) {
                alert('Nessun file da salvare');
                return;
            }
            
            // Simulazione salvataggio
            showLoading('Salvataggio in corso...');
            setTimeout(() => {
                hideLoading();
                alert(`File "${appState.activeFile.name}" salvato con successo`);
            }, 1000);
        }

        // Utility per gestire il pulsante Esporta
        document.getElementById('export-btn').addEventListener('click', () => {
            if (!appState.activeFile) {
                alert('Nessun file da esportare');
                return;
            }
            
            const type = detectFileType(appState.activeFile.name);
            let message = '';
            
            switch(type) {
                case 'image':
                    message = 'Esporta come: PNG, JPG, PDF';
                    break;
                case 'audio':
                    message = 'Esporta come: MP3, WAV';
                    break;
                case 'video':
                    message = 'Esporta come: MP4, GIF';
                    break;
                case 'cad':
                    message = 'Esporta come: STL, OBJ, PDF';
                    break;
                default:
                    message = 'Esporta come: PDF';
            }
            
            alert(message);
        });
    </script>
</body>
</html>
